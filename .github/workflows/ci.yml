full:
  runs-on: ubuntu-latest
  if: github.event_name == 'push'
  needs: lint

  services:
    postgres:
      image: postgres:15
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: nuevo_proyecto_test
      ports:
        - 5432:5432
      options: >-
        --health-cmd="pg_isready -U postgres"
        --health-interval=10s
        --health-timeout=5s
        --health-retries=5

  env:
    DATABASE_URL: postgres://postgres:postgres@postgres:5432/nuevo_proyecto_test
    NODE_ENV: test

  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: npm
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Wait for postgres
      run: |
        until pg_isready -h postgres -p 5432 -U postgres; do
          echo "Waiting for Postgres..."
          sleep 2
        done

    - name: Run Prisma migrations
      run: npx prisma migrate deploy

    - name: Seed database
      run: npm run db:seed

    - name: Run full test suite
      run: npm run test
